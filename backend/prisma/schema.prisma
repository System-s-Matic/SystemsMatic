// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL") // utilisée par l'app au runtime
  directUrl = env("DIRECT_URL") // utilisée par prisma migrate en prod
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REJECTED
  COMPLETED
}

enum AppointmentReason {
  DIAGNOSTIC
  INSTALLATION
  MAINTENANCE
  AUTRE
}

model Contact {
  id           String        @id @default(cuid())
  firstName    String
  lastName     String
  email        String        @db.Citext
  phone        String?
  consentAt    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  appointments Appointment[]

  @@unique([email])                
  @@index([lastName, firstName])    
}

model Appointment {
  id                  String             @id @default(cuid())
  contactId           String
  contact             Contact            @relation(fields: [contactId], references: [id])

  // Demande

  reason              AppointmentReason?
  reasonOther         String?
  message             String?

  // Planif

  status              AppointmentStatus  @default(PENDING)
  scheduledAt         DateTime?          // défini quand confirmé
  durationMinutes     Int                @default(30)   // non-nullable
  timezone            String             @default("America/Guadeloupe")
  location            String?

  // Self-service

  confirmationToken   String             @unique
  cancellationToken   String             @unique

  confirmedAt         DateTime?
  cancelledAt         DateTime?

  // Rappels & emails

  reminderJobId       String?
  reminderScheduledAt DateTime?
  reminderSentAt      DateTime?
  lastEmailAt         DateTime?

  // Traces

  createdIp           String?
  userAgent           String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // Relations
  emailLogs           EmailLog[]

  @@index([contactId])
  @@index([status, scheduledAt])
  @@index([scheduledAt])

  // empêcher deux RDV au même instant pour un même contact
  @@unique([contactId, scheduledAt])
}

model EmailLog {
  id            String        @id @default(cuid())
  appointmentId String?
  appointment   Appointment?  @relation(fields: [appointmentId], references: [id])
  to            String
  subject       String
  template      String
  sentAt        DateTime      @default(now())
  meta          Json?
}
