// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // utilisée par l'app au runtime
  directUrl = env("DIRECT_URL") // utilisée par prisma migrate en prod
}

// --- ENUMS ---

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REJECTED
  COMPLETED
}

enum AppointmentReason {
  DIAGNOSTIC
  INSTALLATION
  MAINTENANCE
  AUTRE
}

// --- MODELS ---

model Contact {
  id        String    @id @default(cuid())
  firstName String
  lastName  String
  email     String    @db.Citext
  phone     String?
  consentAt DateTime? @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)

  appointments Appointment[]

  @@unique([email])
  @@index([lastName, firstName])
}

model Appointment {
  id        String  @id @default(cuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])

  // Demande
  reason      AppointmentReason?
  reasonOther String?
  message     String?
  requestedAt DateTime           @db.Timestamptz(6)

  // Planif
  status      AppointmentStatus @default(PENDING)
  scheduledAt DateTime?         @db.Timestamptz(6)

  // Self-service (tokens opaques envoyés via header)
  confirmationToken String    @unique
  cancellationToken String    @unique
  confirmedAt       DateTime? @db.Timestamptz(6)
  cancelledAt       DateTime? @db.Timestamptz(6)

  // Traces
  createdIp String?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  emailLogs EmailLog[]
  reminders Reminder[]

  // Empêcher deux RDV planifiés au même instant pour un même contact
  @@unique([contactId, scheduledAt])
  @@index([contactId])
  @@index([status, scheduledAt])
  @@index([scheduledAt])
}

model EmailLog {
  id            String       @id @default(cuid())
  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  to            String       @db.Citext
  subject       String
  template      String
  sentAt        DateTime     @default(now()) @db.Timestamptz(6)
  meta          Json?
}

model Reminder {
  id            String      @id @default(cuid())
  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  dueAt         DateTime    @db.Timestamptz(6)
  sentAt        DateTime?   @db.Timestamptz(6)
  providerRef   String?
  createdAt     DateTime    @default(now()) @db.Timestamptz(6)
}
