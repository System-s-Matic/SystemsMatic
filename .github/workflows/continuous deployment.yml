name: Continuous Deployment — System's Matic (VPS)

on:
  workflow_run:
    workflows: ["Continuous Delivery — System's Matic (GHCR)"]
    branches: [main]
    types: [completed]

jobs:
  deploy:
    name: Deployment to VPS
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Connect to VPS and run deploy.sh
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /home/ubuntu/SystemsMatic
            chmod +x deploy.sh
            ./deploy.sh

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            **Déploiement terminé — System's Matic**
            Résultat : ${{ needs.deploy.result }}
